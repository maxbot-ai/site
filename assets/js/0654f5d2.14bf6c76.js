"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[439],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),d=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=d(e.components);return o.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=d(n),p=a,h=u["".concat(l,".").concat(p)]||u[p]||m[p]||r;return n?o.createElement(h,i(i({ref:t},c),{},{components:n})):o.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:a,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8211:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var o=n(7462),a=(n(7294),n(3905));const r={},i="Bots",s={unversionedId:"coding-guides/bots",id:"coding-guides/bots",title:"Bots",description:"The bot consists of several different components. The bot builder allows you to customize these components before loading resources.",source:"@site/docs/coding-guides/bots.md",sourceDirName:"coding-guides",slug:"/coding-guides/bots",permalink:"/coding-guides/bots",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Basic Example",permalink:"/coding-guides/basic-example"},next:{title:"Resources",permalink:"/coding-guides/resources"}},l={},d=[{value:"SQL Engine for State Tracker",id:"sql-engine-for-state-tracker",level:2},{value:"Jinja Filters, Tests and Globals",id:"jinja-filters-tests-and-globals",level:2},{value:"Receiving Custom Messages",id:"receiving-custom-messages",level:2},{value:"Sending Custom Commands",id:"sending-custom-commands",level:2},{value:"Extending scenario context",id:"extending-scenario-context",level:2},{value:"Conversation audit",id:"conversation-audit",level:2}],c={toc:d};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"bots"},"Bots"),(0,a.kt)("p",null,"The bot consists of several different components. The bot builder allows you to customize these components before loading resources."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"from maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n#\n# here you can customize your bot by changing builder properties\n#\nbuilder.use_file_resources('bot.yaml')\nbot = builder.build()\n")),(0,a.kt)("p",null,"Below are examples of customizing the bot."),(0,a.kt)("h2",{id:"sql-engine-for-state-tracker"},"SQL Engine for State Tracker"),(0,a.kt)("p",null,"MaxBot uses the ",(0,a.kt)("inlineCode",{parentName:"p"},"state_tracker")," component to persist the state of the conversation. The default implementation is based on the ",(0,a.kt)("a",{parentName:"p",href:"https://www.sqlalchemy.org"},"sqlalchemy")," library with the in-memory sqlite engine preconfigured. You can set your own sqlalchemy ",(0,a.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/14/core/engines.html"},"engine")," by accessing the ",(0,a.kt)("inlineCode",{parentName:"p"},"engine")," property."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"from maxbot import MaxBot\n\nbuilder = MaxBot.builder()\nbuilder.state_tracker.engine = sqlalchemy.create_engine(...)\nbot = builder.build()\n")),(0,a.kt)("p",null,"Note that all tables needed to persist the state will be created immediately after you set the ",(0,a.kt)("inlineCode",{parentName:"p"},"engine")," property."),(0,a.kt)("h2",{id:"jinja-filters-tests-and-globals"},"Jinja Filters, Tests and Globals"),(0,a.kt)("p",null,"MaxBot actively uses the ",(0,a.kt)("a",{parentName:"p",href:"https://jinja.palletsprojects.com"},"Jinja")," template engine in its conversation scenarios. Jinja itself is highly customizable, so you can configure it directly through the ",(0,a.kt)("inlineCode",{parentName:"p"},"jinja_env")," property of the ",(0,a.kt)("inlineCode",{parentName:"p"},"builder"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"builder.jinja_env.add_extension(...)\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"builder")," also provides convenience methods and decorators for adding filters, test and globals to the jinja environment."),(0,a.kt)("p",null,"Here is an example of adding and using a simple filter. The filter will reverse the incoming string."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'from maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n\n@builder.template_filter()\ndef reverse(s):\n    return s[::-1]\n\nbuilder.use_inline_resources("""\n    dialog:\n      - condition: message.text\n        response: !jinja "{{ message.text|reverse }}"\n""")\nbot = builder.build()\n\ndialog = {"channel_name": "cli", "user_id": 1}\nmessage = {"text": "abcdef"}\nprint(bot.process_message(message, dialog))\n# [{\'text\': \'fedcba\'}]\n')),(0,a.kt)("p",null,"Alternative ways to add such filter."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"def reverse(s):\n    return s[::-1]\n\n# add a filter using a method\nbuilder.add_template_filter(reverse, 'reverse')\n\n# add a filter via direct access to jinja environment\nbuilder.jinja_env.filters['reverse'] = reverse\n")),(0,a.kt)("p",null,"There are similar methods to add globals and tests to the jinja environment."),(0,a.kt)("h2",{id:"receiving-custom-messages"},"Receiving Custom Messages"),(0,a.kt)("p",null,"Messages are what your bot receives from users. MaxBot supports most common message types by default, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"text")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"image"),". You can add any custom message type depending on your needs."),(0,a.kt)("p",null,"Each message type has a name and structure that are validated by marshmallow schema. To add a custom message, you need to declare its schema class and register its name and schema using the decorator ",(0,a.kt)("inlineCode",{parentName:"p"},"builder.message")," or method ",(0,a.kt)("inlineCode",{parentName:"p"},"builder.add_message"),". After that you are allowed to pass the message of specified structure to the ",(0,a.kt)("inlineCode",{parentName:"p"},"process_message")," mehtod of the bot. You can access the message fields in your conversational scenarios via the ",(0,a.kt)("inlineCode",{parentName:"p"},"message")," template variable."),(0,a.kt)("p",null,"See an example of creating ",(0,a.kt)("inlineCode",{parentName:"p"},"contact")," message that allows user to pass some basic contact information to the bot, including their name and phone number."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'from marshmallow import fields, Schema\nfrom maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n\n@builder.message("contact")\nclass ContactMessage(Schema):\n    phone = fields.String(required=True)\n    name = fields.String()\n\nbuilder.use_inline_resources("""\n    dialog:\n      - condition: message.contact\n        response: !jinja "Received {{ message.contact.phone }}"\n""")\nbot = builder.build()\n\ndialog = {"channel_name": "cli", "user_id": 1}\nmessage = {"contact": {"phone": "1-541-754-3010"}}\nprint(bot.process_message(message, dialog))\n# [{\'text\': \'Received 1-541-754-3010\'}]\n')),(0,a.kt)("h2",{id:"sending-custom-commands"},"Sending Custom Commands"),(0,a.kt)("p",null,"Commands are what your bot sends to users. As for messages, MaxBot supports most common command types by default and you can add any custom command type."),(0,a.kt)("p",null,"Each command type has a name and structure that are validated by marshmallow schema. To add a custom command, you need to declare its schema class and register its name and schema using the decorator ",(0,a.kt)("inlineCode",{parentName:"p"},"builder.command")," or method ",(0,a.kt)("inlineCode",{parentName:"p"},"builder.add_command"),". After that you are allowed to use the command of specified structure in conversational scenarios and this command will be returned in the result of the ",(0,a.kt)("inlineCode",{parentName:"p"},"process_message")," method of the bot."),(0,a.kt)("p",null,"Below is an example of adding the ",(0,a.kt)("inlineCode",{parentName:"p"},"location")," command, which allows you to send an arbitrary point on the map to the user."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'from marshmallow import fields, Schema\nfrom maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n\n@builder.command("location")\nclass LocationCommand(Schema):\n    longitude = fields.Float(required=True)\n    latitude = fields.Float(required=True)\n\nbuilder.use_inline_resources("""\n    dialog:\n      - condition: message.text == "Where are you?"\n        response:\n          - location: {latitude: 40.7580, longitude: -73.9855}\n""")\nbot = builder.build()\n\ndialog = {"channel_name": "cli", "user_id": 1}\nmessage = {"text": "Where are you?"}\nprint(bot.process_message(message, dialog))\n# [{\'location\': {\'longitude\': -73.9855, \'latitude\': 40.758}}]\n')),(0,a.kt)("h2",{id:"extending-scenario-context"},"Extending scenario context"),(0,a.kt)("p",null,"Scenario context contains the data needed to control the conversation logic. MaxBot provides a lot of data for the context, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"message")," received from user, ",(0,a.kt)("inlineCode",{parentName:"p"},"intents"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"entities")," and more."),(0,a.kt)("p",null,"The following example shows how to extend the scenario context with a user profile taken from an external source."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'from maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n\n# this is a stub, actually you can load user\n# profile from database or external api\ndef _load_profile(user_id):\n    return {\n        "username": "Yours Truly"\n    }\n\n@builder.before_turn\ndef provide_profile(ctx):\n    ctx.extend_scenario_context(\n        profile=_load_profile(ctx.dialog.user_id)\n    )\n\nbuilder.use_inline_resources("""\n    dialog:\n      - condition: profile.username\n        response: !jinja \'Hello, {{ profile.username }}!\'\n""")\nbot = builder.build()\n\ndialog = {"channel_name": "cli", "user_id": 1}\nmessage = {"text": "hello"}\nprint(bot.process_message(message, dialog))\n#[{\'text\': \'Hello, Yours Truly!\'}]\n')),(0,a.kt)("p",null,"In the above example, we do the following."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"We register the ",(0,a.kt)("inlineCode",{parentName:"li"},"before_turn")," hook. This hook is called at the beginning of processing each message received from the user."),(0,a.kt)("li",{parentName:"ul"},"We get the ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx")," object as the first argument to the hook. This object is an instance of the ",(0,a.kt)("inlineCode",{parentName:"li"},"TurnContext")," class wich represents all information about the current turn of the  conversation."),(0,a.kt)("li",{parentName:"ul"},"We access ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.dialog.user_id")," attribute of the context to get the user identifier. We then load the user profile from an external source using it."),(0,a.kt)("li",{parentName:"ul"},"We extend the scenario context with the loaded user profile using the ",(0,a.kt)("inlineCode",{parentName:"li"},"ctx.extend_scenario_context")," method."),(0,a.kt)("li",{parentName:"ul"},"Finally, we successfuly use the ",(0,a.kt)("inlineCode",{parentName:"li"},"profile")," template variable to get the ",(0,a.kt)("inlineCode",{parentName:"li"},"username")," in our simple conversation scenario.")),(0,a.kt)("h2",{id:"conversation-audit"},"Conversation audit"),(0,a.kt)("p",null,"The result of processing the received message is the list of commands that need to be send to the user. During the processing commands are written to the ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.commands")," attribute of the ",(0,a.kt)("inlineCode",{parentName:"p"},"TurnContext"),".  You can access to these commands before sending using the ",(0,a.kt)("inlineCode",{parentName:"p"},"after_turn")," hook."),(0,a.kt)("p",null,"In the example we show how to use ",(0,a.kt)("inlineCode",{parentName:"p"},"after_turn")," hook to perform conversation audit. Using the ",(0,a.kt)("inlineCode",{parentName:"p"},"TurnContext")," we access all the informatin about the current conversation turn. We simply print this information to stdout."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'from maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n\n@builder.after_turn\ndef journal_conversation(ctx, listening):\n    print ((\n        f"Got {ctx.message}\\n"\n        f"from {ctx.dialog}\\n"\n        f"with response {ctx.commands}."\n    ))\n\nbuilder.use_inline_resources("""\n    dialog:\n      - condition: message.text == \'hello\'\n        response: Good day to you!\n""")\nbot = builder.build()\n\ndialog = {"channel_name": "cli", "user_id": 1}\nmessage = {"text": "hello"}\nbot.process_message(message, dialog)\n# Got {\'text\': \'hello\'}\n# from {\'channel_name\': \'cli\', \'user_id\': 1}\n# with response [{\'text\': \'Good day to you!\'}].\n')))}u.isMDXComponent=!0}}]);