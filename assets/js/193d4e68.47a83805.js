"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[712],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>y});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=o.createContext({}),s=function(e){var t=o.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=s(e.components);return o.createElement(p.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},h=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=s(n),h=a,y=c["".concat(p,".").concat(h)]||c[h]||d[h]||r;return n?o.createElement(y,l(l({ref:t},u),{},{components:n})):o.createElement(y,l({ref:t},u))}));function y(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=h;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[c]="string"==typeof e?e:a,l[1]=i;for(var s=2;s<r;s++)l[s]=n[s];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}h.displayName="MDXCreateElement"},120:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>i,toc:()=>s});var o=n(7462),a=(n(7294),n(3905));const r={},l="Packaging Guide",i={unversionedId:"coding-guides/packaging",id:"coding-guides/packaging",title:"Packaging Guide",description:"When you create a conversational app with maxbot it's a good choice to create your own Python package. That's what allows you to distribute your app, e.g. deploy and run it on a remote server.",source:"@site/docs/coding-guides/packaging.md",sourceDirName:"coding-guides",slug:"/coding-guides/packaging",permalink:"/coding-guides/packaging",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Extensions",permalink:"/coding-guides/extensions"}},p={},s=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Create a Project",id:"create-a-project",level:2},{value:"Dependencies and Environment",id:"dependencies-and-environment",level:2},{value:"Create Your Bot",id:"create-your-bot",level:2},{value:"Add Resources",id:"add-resources",level:2},{value:"Keep Your Secrets",id:"keep-your-secrets",level:2},{value:"Install your package",id:"install-your-package",level:2},{value:"Run The Bot",id:"run-the-bot",level:2},{value:"Test your code",id:"test-your-code",level:2},{value:"Write some stories",id:"write-some-stories",level:2},{value:"Create a wheel package",id:"create-a-wheel-package",level:2},{value:"Deploy your package",id:"deploy-your-package",level:2},{value:"What&#39;s next",id:"whats-next",level:2}],u={toc:s};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"packaging-guide"},"Packaging Guide"),(0,a.kt)("p",null,"When you create a conversational app with ",(0,a.kt)("strong",{parentName:"p"},"maxbot")," it's a good choice to create your own Python package. That's what allows you to distribute your app, e.g. deploy and run it on a remote server."),(0,a.kt)("p",null,"Nowadays, there are several ways and tools to create Python packages (what you install with ",(0,a.kt)("inlineCode",{parentName:"p"},"pip install something"),"). You might even have your favorite already."),(0,a.kt)("p",null,"Here's a guide, showing one of the alternative ways of creating a Python package with a ",(0,a.kt)("strong",{parentName:"p"},"maxbot")," conversational app, from scratch."),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("p",null,"For this tutorial we'll use ",(0,a.kt)("a",{parentName:"p",href:"https://python-poetry.org"},"Poetry"),"."),(0,a.kt)("p",null,"Poetry's docs are great, so go ahead, check them and install it."),(0,a.kt)("h2",{id:"create-a-project"},"Create a Project"),(0,a.kt)("p",null,"Let's say we want to create a ",(0,a.kt)("strong",{parentName:"p"},"maxbot")," application called ",(0,a.kt)("inlineCode",{parentName:"p"},"hello-world"),".`"),(0,a.kt)("p",null,"Create a project with Poetry:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ poetry new hello-world\nCreated package hello_world in hello-world\n")),(0,a.kt)("p",null,"Enter the new project directory:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ cd hello-world/\n")),(0,a.kt)("p",null,"You can see that you have a generated project structure that looks like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ tree\n.\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 hello_world\n\u2502\xa0\xa0 \u2514\u2500\u2500 __init__.py\n\u251c\u2500\u2500 poetry.lock\n\u251c\u2500\u2500 pyproject.toml\n\u2514\u2500\u2500 tests\n    \u2514\u2500\u2500 __init__.py\n")),(0,a.kt)("h2",{id:"dependencies-and-environment"},"Dependencies and Environment"),(0,a.kt)("p",null,"Add ",(0,a.kt)("inlineCode",{parentName:"p"},"maxbot[all]")," to your dependencies. This command also creates a virtual environment for your project:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ poetry add maxbot[all]\nCreating virtualenv hello-world-g89_GtdQ-py3.9 in /Users/user_name/Library/Caches/pypoetry/virtualenvs\nUsing version ^0.1.0.dev20220922191958 for maxbot\n\nUpdating dependencies\nResolving dependencies... (6.9s)\n\nWriting lock file\n\nPackage operations: 47 installs, 1 update, 0 removals\n\n  ...omit lots of dependencies...\n  \u2022 Installing maxbot (0.1.0.dev20220922191958)\n")),(0,a.kt)("p",null,"Activate that new virtual environment."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ poetry shell\nSpawning shell within /Users/user_name/Library/Caches/pypoetry/virtualenvs/hello-world-g89_GtdQ-py3.9\n")),(0,a.kt)("h2",{id:"create-your-bot"},"Create Your Bot"),(0,a.kt)("p",null,"Now let's create an extremely simple bot."),(0,a.kt)("p",null,"Add the following code into the ",(0,a.kt)("inlineCode",{parentName:"p"},"hello_world/__init__.py"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},"from maxbot import MaxBot\n\nbuilder = MaxBot.builder()\n#\n# here you can customize your bot by changing builder properties\n#\nbuilder.use_package_resources(__name__)\nbot = builder.build()\n")),(0,a.kt)("p",null,"The bot uses ",(0,a.kt)("inlineCode",{parentName:"p"},"builder.use_package_resources")," to load resources. ",(0,a.kt)("inlineCode",{parentName:"p"},"__name__")," is the name of the current Python package ",(0,a.kt)("inlineCode",{parentName:"p"},"hello_world"),". The bot needs to know where it\u2019s located to load resources, and ",(0,a.kt)("inlineCode",{parentName:"p"},"__name__")," is a convenient way to tell it that."),(0,a.kt)("h2",{id:"add-resources"},"Add Resources"),(0,a.kt)("p",null,"All resources are located in the package directory ",(0,a.kt)("inlineCode",{parentName:"p"},"hello_world"),"."),(0,a.kt)("p",null,"In our project let's create a single file ",(0,a.kt)("inlineCode",{parentName:"p"},"hello_world/bot.yaml")," with the contents from ",(0,a.kt)("a",{parentName:"p",href:"/getting-started/quick-start"},"Quick Start Guide"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"channels:\n    telegram:\n        api_token: YOUR_TELEGRAM_API_TOKEN\nintents:\n  - name: greetings\n    examples: [Good morning, Hello, Hi]\n  - name: ending\n    examples: [Goodbye, Bye, See you]\ndialog:\n  - condition: intents.greetings\n    response: Good day to you!\n  - condition: intents.ending\n    response: OK. See you later.\n  - condition: true\n    response: Sorry I don't understand.\n")),(0,a.kt)("p",null,"Of course, if you have a lot of resources, you can split them into multiple files and subdirectories in the package directory."),(0,a.kt)("h2",{id:"keep-your-secrets"},"Keep Your Secrets"),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"telegram")," channel settings in the ",(0,a.kt)("inlineCode",{parentName:"p"},"bot.yaml")," contains ",(0,a.kt)("inlineCode",{parentName:"p"},"api_token")," which is the secret token used to authenticate your bot. It's good practice to store such secrets in environment variables rather than in code."),(0,a.kt)("p",null,"So write the reference to the environment variable ",(0,a.kt)("inlineCode",{parentName:"p"},"TELEGRAM_API_KEY")," instead of actual value ",(0,a.kt)("inlineCode",{parentName:"p"},"YOUR_TELEGRAM_API_TOKEN"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"channels:\n    telegram:\n        api_token: !ENV ${TELEGRAM_API_KEY}\n")),(0,a.kt)("p",null,"Perhaps you don't want to reveal your secret to anyone, not even your team. Then a good place to put your secret environment variables is the virtualenv\u2019s activate script. This script is located outside the project directory and will not be accessible to anyone but you."),(0,a.kt)("p",null,"You can get the path to your virtualenv with the ",(0,a.kt)("inlineCode",{parentName:"p"},"poetry env info -p")," command. So put the following contents to the end of the script ",(0,a.kt)("inlineCode",{parentName:"p"},"$(poetry env info -p)/bin/activate"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'export TELEGRAM_API_KEY="YOUR_TELEGRAM_API_TOKEN"\n')),(0,a.kt)("p",null,"Activating the virtualenv will set the variables."),(0,a.kt)("h2",{id:"install-your-package"},"Install your package"),(0,a.kt)("p",null,"You can now install your package:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ poetry install\nInstalling dependencies from lock file\n\nNo dependencies to install or update\n\nInstalling the current project: hello-world (0.1.0)\n")),(0,a.kt)("p",null,"Your package is installed in ",(0,a.kt)("a",{parentName:"p",href:"https://pip.pypa.io/en/stable/topics/local-project-installs/#editable-installs"},"editable mode")," in the environment created by Poetry. Editable (or development) mode means that as you make changes to your local code, you\u2019ll only need to re-install if you change the metadata about the project, such as its dependencies."),(0,a.kt)("h2",{id:"run-the-bot"},"Run The Bot"),(0,a.kt)("p",null,"Now you can run your bot using the ",(0,a.kt)("inlineCode",{parentName:"p"},"maxbot run")," command."),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"maxbot")," command is installed by ",(0,a.kt)("strong",{parentName:"p"},"maxbot")," package, not your application. It must be told where to find your bot in order to use it. The ",(0,a.kt)("inlineCode",{parentName:"p"},"--bot")," option is used to specify how to load the bot."),(0,a.kt)("p",null,"Your bot is in the ",(0,a.kt)("inlineCode",{parentName:"p"},"hello_world")," package in the variable called ",(0,a.kt)("inlineCode",{parentName:"p"},"bot"),". So type the following"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ maxbot run --bot hello_world:bot\n")),(0,a.kt)("p",null,"You\u2019ll see output similar to this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"TODO: just ptb logs for now\n")),(0,a.kt)("p",null,'Open your telegram bot in the Telegram app, type "hello" and see the answer. Congratulations, you\u2019re now running your ',(0,a.kt)("strong",{parentName:"p"},"maxbot")," conversational application!"),(0,a.kt)("h2",{id:"test-your-code"},"Test your code"),(0,a.kt)("p",null,"TODO:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"just plain python tests using pytest"),(0,a.kt)("li",{parentName:"ul"},"need a bit advanced codebase to test it")),(0,a.kt)("h2",{id:"write-some-stories"},"Write some stories"),(0,a.kt)("p",null,"TODO:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'move stories from "quick start" tutorial'),(0,a.kt)("li",{parentName:"ul"},"need pytest plugin to run the stories"),(0,a.kt)("li",{parentName:"ul"},"need click environments and dotenv to not to repeat --bot option")),(0,a.kt)("h2",{id:"create-a-wheel-package"},"Create a wheel package"),(0,a.kt)("p",null,'Python packages have a standard format called a "wheel". It\'s a file that ends in .whl.'),(0,a.kt)("p",null,"You can create a wheel with Poetry:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ poetry build\nBuilding hello-world (0.1.0)\n  - Building sdist\n  - Built hello-world-0.1.0.tar.gz\n  - Building wheel\n  - Built hello_world-0.1.0-py3-none-any.whl\n")),(0,a.kt)("p",null,"After that, if you check in your project directory, you should now have a couple of extra files at ",(0,a.kt)("inlineCode",{parentName:"p"},"dist/"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ tree dist/\ndist/\n\u251c\u2500\u2500 hello-world-0.1.0.tar.gz\n\u2514\u2500\u2500 hello_world-0.1.0-py3-none-any.whl\n")),(0,a.kt)("p",null,"The .whl is the wheel file. You can send that wheel file to anyone and they can use it to install your program."),(0,a.kt)("p",null,"The wheel file only includes source code and resources contained in the ",(0,a.kt)("inlineCode",{parentName:"p"},"hello_world/")," directory (your Python package)."),(0,a.kt)("h2",{id:"deploy-your-package"},"Deploy your package"),(0,a.kt)("p",null,"Let's say you have a server that you want to deploy your bot to. If you don't have a server you can open another terminal and set up a new virtual environment on your development computer to try out the instructions below."),(0,a.kt)("p",null,"You need to copy the wheel file to your server then install it with pip."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ pip install hello_world-0.1.0-py3-none-any.whl\n")),(0,a.kt)("p",null,"This will install your package along with its dependencies, i.e. the ",(0,a.kt)("strong",{parentName:"p"},"maxbot")," package."),(0,a.kt)("p",null,"The next step is to configure your application by setting the required environment variables on your server. The way you set variables depends on your server setup. We just export the variables before running the application."),(0,a.kt)("p",null,"Now you have your conversatinoal app installed and configured on yor server. And you can use it freely:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'$ export TELEGRAM_API_KEY="YOUR_TELEGRAM_API_TOKEN"\n$ maxbot run --bot hello_world:bot\n')),(0,a.kt)("h2",{id:"whats-next"},"What's next"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Use ",(0,a.kt)("a",{parentName:"li",href:"https://git-scm.com"},"Git"),", the version control system, to save your code."),(0,a.kt)("li",{parentName:"ul"},"Integrate a CI tool to run your tests and deploy your package automatically.")))}c.isMDXComponent=!0}}]);